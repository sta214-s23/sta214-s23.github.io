---
title: "Class Activity, March 20"
output: 
  tufte::tufte_html:
    css: "lab.css"
    tufte_variant: "envisioned"
    highlight: pygments
link-citations: yes
---

# Part I: The Framingham heart study

The data in this class activity comes from a study on residents of Framingham, MA, which was conducted to research variables related to heart health. We will work with a subset of the data, containing

* `cigsPerDay`: The number of cigarettes smoked per day during the study period.
* `education`: 1 = High School, 2 = Some College, 3 = College Degree, 4 = Advanced Degree.
* `male`: 1 = Male, 0 = Female.
* `age`: The age of the individual in years.
* `diabetes`: 1 if the individual has diabetes, 0 otherwise.
* `BMI`: the individual's body mass index (BMI)
* `currentSmoker`: 1 if the individual currently smokes, 0 otherwise

```{r, include=F}
library(tidyverse)
heart_data <- read.csv("~/Documents/Teaching/sta214-f22.github.io/class_activities/framingham.csv")

heart_data <- heart_data %>%
  drop_na(male, age, education, diabetes, cigsPerDay, BMI) %>%
  mutate(education = as.factor(education))
```

## Questions

While the data were originally collected to study heart health, in this activity we will try to model the number of cigarettes smoked. Since not all participants are smokers, we will restrict our analysis only to the current smokers in the data.

Below is the output of Poisson and quasi-Poisson regression models using this data. Use this output to answer the following question.

1. Perform a goodness of fit test to assess whether the initial Poisson model is a good fit to the data. Why might the model be a poor fit?

2. Find the estimated dispersion parameter $\widehat{\phi}$.



## Output

```{r}
smokers <- heart_data %>%
  filter(currentSmoker == 1)

m1 <- glm(cigsPerDay ~ male + age + education + diabetes + BMI,
          data = smokers, family = poisson)
summary(m1)
```

```{r}
m2 <- glm(cigsPerDay ~ male + age + education + diabetes + BMI,
          data = smokers, family = quasipoisson)
summary(m2)
```


# Part II: Negative binomial vs. Poisson regression

The negative binomial distribution allows a more flexible mean-variance relationship than the Poisson distribution. For the Poisson distribution, $V(\mu) = \mu$, whereas for the negative binomial $V(\mu) = \mu + \dfrac{\mu^2}{\theta}$. For large values of $\theta$, the negative binomial is similar to the Poisson, whereas for small values of $\theta$ the negative binomial allows much more variability in the response.

In this class activity, we will simulate data from the Poisson and the negative binomial, and we will compare Poisson regression with negative binomial regression.

### Simulating data

Run the following code in R to simulate $X$ from a normal distribution, and two different response variables; $Y_{(1)}$ is Poisson, and $Y_{(2)}$ is negative binomial with $\theta = 1$.

```{r, eval=F}
theta <- 1
x <- rnorm(1000, mean=0, sd=1.2)
y1 <- rpois(1000, lambda = exp(x))
y2 <- rnbinom(1000, size=theta, mu=exp(x))
```

### Visualizing the results

Let's compare the plots of $Y_{(1)}$ vs. $X$ and $Y_{(2)}$ vs $X$. Run the following code:

```{r, eval=F}
plot(x, y1, main = "Poisson response")
plot(x, y2, main = "Negative binomial response")
```

3. What do you notice about the difference in the variability of $Y$ for the Poisson vs. negative binomial data?

### Fitting models on the Poisson data

Now let's fit both a Poisson regression model and a negative binomial regression model *on the Poisson data*, and compare the quantile residual plots.


```{r, eval=F}
library(MASS)
library(statmod)
library(tidyverse)

m1 <- glm(y1 ~ x, family = poisson)
m2 <- glm.nb(y1 ~ x)

summary(m1)
summary(m2)

data.frame(x = x, resids = qresid(m1)) %>%
  ggplot(aes(x = x, y = resids)) +
  geom_point() +
  geom_smooth() +
  labs(x = "X", y = "Quantile residuals",
       title = "Poisson regression on Poisson data") +
  theme_bw()

data.frame(x = x, resids = qresid(m2)) %>%
  ggplot(aes(x = x, y = resids)) +
  geom_point() +
  geom_smooth() +
  labs(x = "X", y = "Quantile residuals",
       title = "Negative binomial regression on Poisson data") +
  theme_bw()
```

4. Are the estimated coefficients for the two models similar? What is the estimate $\widehat{\theta}$ for the negative binomial model?

5. Do the quantile residual plots for both models look reasonable?


### Fitting models on the negative binomial data

Now let's fit both a Poisson regression model and a negative binomial regression model *on the negative binomial data*, and compare the quantile residual plots.


```{r, eval=F}
m1 <- glm(y2 ~ x, family = poisson)
m2 <- glm.nb(y2 ~ x)

summary(m1)
summary(m2)

data.frame(x = x, resids = qresid(m1)) %>%
  ggplot(aes(x = x, y = resids)) +
  geom_point() +
  geom_smooth() +
  labs(x = "X", y = "Quantile residuals",
       title = "Poisson regression on negative binomial data") +
  theme_bw()

data.frame(x = x, resids = qresid(m2)) %>%
  ggplot(aes(x = x, y = resids)) +
  geom_point() +
  geom_smooth() +
  labs(x = "X", y = "Quantile residuals",
       title = "Negative binomial regression on negative binomial data") +
  theme_bw()
```

6. Are the estimated coefficients for the two models similar? What is the estimate $\widehat{\theta}$ for the negative binomial model?

7. Do the quantile residual plots for both models look reasonable?

